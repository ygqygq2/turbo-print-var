import path from 'path';

import { CodeContext, LanguageConfig, LogBuildOptions, UserConfig } from '../types';
import { escapeString } from '../utils/text';

/**
 * 日志消息构建器
 */
export class LogMessageBuilder {
  /**
   * 构建完整的日志语句
   */
  build(options: LogBuildOptions): string {
    const { variable, context, config, languageConfig } = options;

    // 获取日志函数
    const logFunction = this.getLogFunction(languageConfig, config);

    // 构建日志消息内容
    const logMessage = this.buildLogMessage(variable, context, config);

    // 构建完整的日志语句
    let logStatement = this.buildLogStatement(logFunction, logMessage, variable, config.quote, languageConfig);

    // 添加分号（如果需要）
    if (this.needsSemicolon(languageConfig, config)) {
      logStatement += ';';
    }

    return logStatement;
  }

  /**
   * 获取日志函数
   */
  private getLogFunction(languageConfig: LanguageConfig, config: UserConfig): string {
    // 检查用户自定义的语言日志函数
    if (config.logFunction[languageConfig.id]) {
      return config.logFunction[languageConfig.id];
    }
    return languageConfig.defaultLogFn;
  }

  /**
   * 构建日志消息内容
   */
  private buildLogMessage(variable: string, context: CodeContext, config: UserConfig): string {
    const parts: string[] = [];

    // 添加前缀
    if (config.prefix) {
      parts.push(config.prefix);
    }

    // 添加文件名和行号
    if (config.includeFileInfo) {
      const fileName = path.basename(context.fileName);
      parts.push(`file: ${fileName}:${context.lineNumber}`);
    }

    // 添加类名（如果有）
    if (context.className) {
      parts.push(context.className);
    }

    // 添加函数名（如果有）
    if (context.functionName) {
      parts.push(context.functionName);
    }

    // 添加变量名和后缀
    parts.push(`${variable}${config.suffix}`);

    // 使用分隔符连接
    return parts.join(` ${config.separator} `);
  }

  /**
   * 构建日志语句
   */
  private buildLogStatement(
    logFunction: string,
    logMessage: string,
    variable: string,
    quote: '"' | "'" | '`',
    languageConfig: LanguageConfig,
  ): string {
    // 转义消息
    const escapedMessage = escapeString(logMessage, quote);

    // 根据不同语言构建不同的语句
    switch (languageConfig.id) {
      case 'c':
        return this.buildCLogStatement(escapedMessage, variable);

      case 'cpp':
        return this.buildCppLogStatement(logMessage, variable);

      case 'php':
        return this.buildPhpLogStatement(logFunction, escapedMessage, variable, quote);

      case 'perl':
        return this.buildPerlLogStatement(logFunction, escapedMessage, variable, quote);

      case 'python':
        return this.buildPythonLogStatement(logFunction, logMessage, variable, quote);

      case 'rust':
        return this.buildRustLogStatement(logFunction, escapedMessage, variable, quote);

      case 'r':
        return this.buildRLogStatement(logFunction, logMessage, variable, quote);

      case 'ruby':
        return this.buildRubyLogStatement(logFunction, escapedMessage, variable, quote);

      case 'coffee':
      case 'coffeescript':
        return this.buildCoffeeScriptLogStatement(logFunction, escapedMessage, variable, quote);

      case 'csharp':
        return this.buildCSharpLogStatement(logFunction, escapedMessage, variable, quote);

      case 'dart':
        return this.buildDartLogStatement(logFunction, escapedMessage, variable, quote);

      case 'groovy':
        return this.buildGroovyLogStatement(logFunction, escapedMessage, variable, quote);

      case 'java':
        return this.buildJavaLogStatement(logFunction, escapedMessage, variable, quote);

      case 'shellscript':
      case 'sh':
      case 'bash':
        return this.buildShellLogStatement(logFunction, escapedMessage, variable, quote);

      default:
        return `${logFunction}(${quote}${escapedMessage}${quote}, ${variable})`;
    }
  }

  /**
   * 构建 C 语言日志语句
   */
  private buildCLogStatement(message: string, variable: string): string {
    // C 语言的 printf 需要格式化字符串
    return `printf("${message} %s\\n", ${variable})`;
  }

  /**
   * 构建 C++ 日志语句
   */
  private buildCppLogStatement(message: string, variable: string): string {
    // C++ 使用 std::cout
    return `std::cout << "${message} " << ${variable} << std::endl`;
  }

  /**
   * 构建 PHP 日志语句
   */
  private buildPhpLogStatement(logFunction: string, message: string, variable: string, quote: '"' | "'" | '`'): string {
    if (logFunction === 'echo') {
      // PHP echo: echo "message \$var: " . $var;
      const escapedVar = `\\${variable}`;
      return `echo ${quote}${message.replace(variable, escapedVar)}${quote} . ${variable}`;
    }
    return `${logFunction}(${quote}${message}${quote}, ${variable})`;
  }

  /**
   * 构建 Perl 日志语句
   */
  private buildPerlLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Perl: print "message \$var: " . $var;
    const escapedVar = `\\${variable}`;
    return `${logFunction} ${quote}${message.replace(variable, escapedVar)}${quote} . ${variable}`;
  }

  /**
   * 构建 Python 日志语句
   */
  private buildPythonLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Python: print("message:", var)
    return `${logFunction}(${quote}${message}${quote}, ${variable})`;
  }

  /**
   * 构建 Rust 日志语句
   */
  private buildRustLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Rust: println!("message {}", var);
    return `${logFunction}(${quote}${message} {}${quote}, ${variable})`;
  }

  /**
   * 构建 R 日志语句
   */
  private buildRLogStatement(logFunction: string, message: string, variable: string, quote: '"' | "'" | '`'): string {
    // R: print(paste("message:", var))
    return `${logFunction}(paste(${quote}${message}${quote}, ${variable}))`;
  }

  /**
   * 构建 Ruby 日志语句
   */
  private buildRubyLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Ruby: puts "message " + var
    return `${logFunction} ${quote}${message} ${quote} + ${variable}`;
  }

  /**
   * 构建 CoffeeScript 日志语句
   */
  private buildCoffeeScriptLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // CoffeeScript: console.log "message " + a
    return `${logFunction} ${quote}${message} ${quote} + ${variable}`;
  }

  /**
   * 构建 C# 日志语句
   */
  private buildCSharpLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // C#: Console.WriteLine("message " + a);
    return `${logFunction}(${quote}${message} ${quote} + ${variable})`;
  }

  /**
   * 构建 Dart 日志语句
   */
  private buildDartLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Dart: print("message " + a);
    return `${logFunction}(${quote}${message} ${quote} + ${variable})`;
  }

  /**
   * 构建 Groovy 日志语句
   */
  private buildGroovyLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Groovy: println "message " + a
    return `${logFunction} ${quote}${message} ${quote} + ${variable}`;
  }

  /**
   * 构建 Java 日志语句
   */
  private buildJavaLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Java: System.out.println("message " + a);
    return `${logFunction}(${quote}${message} ${quote} + ${variable})`;
  }

  /**
   * 构建 Shell 日志语句
   */
  private buildShellLogStatement(
    logFunction: string,
    message: string,
    variable: string,
    quote: '"' | "'" | '`',
  ): string {
    // Shell: echo "message:" ${var}
    return `${logFunction} ${quote}${message}${quote} \${${variable}}`;
  }

  /**
   * 判断是否需要分号
   */
  private needsSemicolon(languageConfig: LanguageConfig, config: UserConfig): boolean {
    // 如果用户明确设置了 addSemicolon，则使用用户设置
    // 否则使用语言默认设置
    if (config.addSemicolon !== undefined) {
      return config.addSemicolon;
    }
    return languageConfig.needsSemicolon;
  }
}
